# Sales Offer Generator — Implementation Plan

**Based on:** Audit Report (2026-01-04)
**Current Score:** 80/100
**Target Score:** 90/100

---

## Summary

The project has made significant progress since the last audit, with test coverage increasing from 21.7% to 47.86%. Critical modules are now well-tested. The remaining priorities are: addressing the xlsx vulnerability, adding tests for ai.js and beta.js, and removing console statements.

---

## Recommended Actions

| Priority | Task | Effort | Relates To |
|----------|------|--------|------------|
| 1 | Address xlsx vulnerability | 2-4h | High severity security issue |
| 2 | Add ai.js tests | 4-6h | Zero coverage module |
| 3 | Add beta.js tests | 6-8h | Zero coverage module |
| 4 | Remove console statements | 1h | Medium priority cleanup |
| 5 | Improve paymentPlan.js coverage | 2-3h | 30.59% coverage |
| 6 | Improve category.js coverage | 2-3h | 43.90% coverage |

---

## Phase 1: Security (Immediate)

### Address xlsx Vulnerability

The xlsx (SheetJS) package has known vulnerabilities with no upstream fix available.

**Options:**

1. **Input validation** — Add strict validation before passing data to xlsx parser
   ```javascript
   // In excel.js - validate file size and type before parsing
   if (file.size > MAX_FILE_SIZE) throw new Error('File too large');
   if (!ALLOWED_TYPES.includes(file.type)) throw new Error('Invalid file type');
   ```

2. **Alternative library** — Consider ExcelJS or read-excel-file
   - ExcelJS: More features, larger bundle
   - read-excel-file: Smaller, read-only

3. **Accept risk** — Document the vulnerability and implement compensating controls

---

## Phase 2: Test Coverage (Short-term)

### Add ai.js Tests

The AI module handles Gemini API integration (501 lines, 0% coverage).

Key functions to test:
- `parseWithAI()` — Main parsing function
- `extractPropertyData()` — Data extraction logic
- `validateApiKey()` — Key validation
- API error handling

```javascript
// tests/ai.test.js structure
describe('AI Module', () => {
    describe('parseWithAI', () => {
        it('should handle valid API response');
        it('should handle API errors gracefully');
        it('should validate required fields');
    });
});
```

### Add beta.js Tests

The beta module contains experimental features (1,193 lines, 0% coverage).

Key functions to test:
- Feature toggle logic
- Beta-specific UI handlers
- Beta calculations

---

## Phase 3: Code Quality (Medium-term)

### Remove Console Statements

Replace 11 console statements with a proper logging utility or remove them.

**Locations:**
- `js/modules/export.js:199, 224`
- `js/modules/pdfGenerator.js:98, 288`
- `js/modules/storage.js:273, 328, 343, 354, 362, 513, 1051`

**Option 1:** Remove all (simplest)
```javascript
// Before
console.warn('Logo could not be added to PDF:', e);

// After (silent fail with fallback)
// Error already handled by try-catch
```

**Option 2:** Create logging utility
```javascript
// js/utils/logger.js
const LOG_LEVEL = process.env.NODE_ENV === 'development' ? 'debug' : 'error';
export const logger = {
    error: (msg, ...args) => LOG_LEVEL !== 'none' && console.error(msg, ...args),
    warn: (msg, ...args) => ['debug', 'warn'].includes(LOG_LEVEL) && console.warn(msg, ...args)
};
```

### Improve Module Coverage

Focus on modules with lowest coverage:

| Module | Current | Target | Gap |
|--------|---------|--------|-----|
| paymentPlan.js | 30.59% | 60% | +29.41% |
| category.js | 43.90% | 70% | +26.10% |
| branding.js | 50% | 70% | +20% |
| helpers.js | 59.64% | 80% | +20.36% |

---

## Expected Outcome

| Metric | Current | After Phase 1 | After Phase 2 | After Phase 3 |
|--------|---------|---------------|---------------|---------------|
| Health Score | 80 | 82 | 88 | 90+ |
| Test Coverage | 47.86% | 48% | 65% | 75% |
| Vulnerabilities | 1 | 0-1 | 0-1 | 0-1 |
| Console statements | 11 | 11 | 11 | 0 |

---

## Completed Actions (Since 2026-01-02)

- [x] Added comprehensive calculator.js tests (+79.85% coverage)
- [x] Added comprehensive excel.js tests (+98.10% coverage)
- [x] Added comprehensive export.js tests (+99.02% coverage)
- [x] Added comprehensive pdfGenerator.js tests (+98.23% coverage)
- [x] Improved validator.js tests (+75.58% coverage)
- [x] Fixed pdfGenerator.js to match live preview layout
- [x] Removed 7 console statements
- [x] Added 206 new tests (224 → 430)
- [x] Increased overall coverage from 21.7% to 47.86%

---

## Testing Commands

```bash
# Run specific test file
npm test tests/export.test.js

# Run with coverage
npm run test:coverage

# Watch mode during development
npm test -- --watch
```

---

*Plan generated by Claude (Auditor Skill)*
