# Session Plan: Sales Offer Generator Remediation

**Based on:** audit/AUDIT_REPORT.md (2025-12-31)
**Current Health Score:** 67/100 (CAUTION) → **80+/100 (HEALTHY)**
**Status:** ✅ COMPLETED

---

## Overview

The Sales Offer Generator is a vanilla JavaScript SPA for generating real estate documents. The audit identified:
- **1 CRITICAL**: No test coverage
- **2 HIGH**: API key storage (Base64 only), missing CSP
- **2 MEDIUM**: Console logs in production, unencrypted localStorage
- **3 LOW**: Minor improvements

---

## Phase 1: Quick Wins (High Impact, Low Effort) ✅ COMPLETED

### Task 1: Add Content Security Policy ✅
- **Finding:** H-02
- **File:** `index.html` (after line 4)
- **Action:** Added CSP meta tag to prevent XSS attacks

### Task 2: Remove Debug Console Statements ✅
- **Finding:** L-03
- **File:** `js/app.js` (lines 30, 60)
- **Action:** Removed "initializing" and "ready" console.log statements

### Task 3: Add .editorconfig ✅
- **Finding:** Best practice
- **File:** New `.editorconfig`
- **Action:** Created editor configuration for code consistency

### Task 4: Add API Key Storage Warning ✅
- **Finding:** H-01
- **File:** `index.html` (settings modal, AI tab)
- **Action:** Added warning text informing users about local storage

### Task 5: Create package.json ✅
- **Finding:** L-02
- **File:** New `package.json`
- **Action:** Documented CDN dependencies and created scripts

---

## Phase 2: Foundation (Testing) ✅ COMPLETED

### Task 6: Add Test Suite with Vitest ✅
- **Finding:** C-01 (CRITICAL - 0% test coverage)
- **Files:** `tests/` directory, `vitest.config.js`, `tests/setup.js`
- **Tests Created:**
  - `tests/helpers.test.js` - 30+ tests for utility functions
  - `tests/calculator.test.js` - 20+ tests for calculation logic
  - `tests/validator.test.js` - 25+ tests for validation

### Task 7: Add ESLint Configuration ✅
- **Finding:** Best practice
- **Files:** `eslint.config.js`
- **Action:** Configured ESLint with security plugin and JS best practices

---

## Phase 3: Security Hardening

### Task 8: Implement Server-Side API Proxy
- **Finding:** H-01
- **Files:** New `server/` directory
- **Action:** Create Node.js proxy to hide API key from client
- **Effort:** L (15-20 hours)

### Task 9: Encrypt Sensitive localStorage Data (Optional)
- **Finding:** M-02
- **Files:** `js/modules/storage.js`, new `js/utils/crypto.js`
- **Action:** Use Web Crypto API for sensitive fields
- **Effort:** M (6-8 hours)
- **Note:** Can skip if Task 8 is implemented

---

## Phase 4: Polish ✅ COMPLETED

### Task 10: Update CDN Dependencies ✅
- xlsx: 0.18.5 (kept - latest on cdnjs)
- html2pdf.js: 0.10.1 → 0.12.1 (updated)
- SortableJS: 1.15.0 → 1.15.6 (updated)
- SRI hashes regenerated

### Task 11: Add Loading States
- Skeleton loaders for PDF generation
- Progress indicator for Excel import
- Loading spinner for AI processing

### Task 12: Add Keyboard Shortcuts
- Ctrl+S: Save current offer
- Ctrl+E: Export dialog
- Ctrl+P: Print

---

## Backlog (Not Recommended)

- **R-01:** TypeScript Migration (XL effort, marginal benefit)
- **R-02:** Framework Migration (XXL effort, skip entirely)

---

## Recommended Execution Order

1. QW-01: Add CSP (30 min)
2. QW-02: Remove debug logs (15 min)
3. QW-03: Add .editorconfig (15 min)
4. QW-04: Add API key warning (1 hour)
5. QW-05: Create package.json (30 min)
6. **MP-01: Add test suite** (20-30 hours) ← CRITICAL
7. MP-02: Add ESLint (4-6 hours)
8. MP-03: Server-side API proxy (15-20 hours)

---

## Success Criteria

After completing Phase 1 + Phase 2:
- Health Score: 67 → 80+
- Test Coverage: 0% → 60%+
- HIGH Security Issues: 2 → 0
- ESLint Errors: Unknown → 0

---

## Files Reference

**Source Files:** 13 JS modules, 7 CSS files, 1 HTML file
**Key Files to Modify:**
- `index.html` - CSP, API warning
- `js/app.js` - Debug logs
- `js/modules/storage.js` - Encryption (optional)
- `js/utils/helpers.js` - API key handling

**New Files to Create:**
- `.editorconfig`
- `package.json`
- `vitest.config.js`
- `eslint.config.js`
- `tests/*.test.js`
